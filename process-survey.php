<?php
// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞
$servername = "localhost";
$username = "surveyuser"; // ÏÉàÎ°ú ÎßåÎì† ÏÇ¨Ïö©ÏûêÎ™Ö
$password = "wldndEhd1!"; // ÎπÑÎ∞ÄÎ≤àÌò∏
$dbname = "survey_db";

// MySQL Ïó∞Í≤∞
$conn = new mysqli($servername, $username, $password, $dbname);

// Ïó∞Í≤∞ ÌôïÏù∏
if ($conn->connect_error) {
    exit(); // Ïä§ÌÅ¨Î¶ΩÌä∏ Ï§ëÎã®
}

// AJAX ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï≤òÎ¶¨
if (isset($_GET['delete_id']) && is_numeric($_GET['delete_id'])) {
    $delete_id = intval($_GET['delete_id']);
    $delete_sql = "DELETE FROM survey_responses WHERE id = $delete_id";
    
    if ($conn->query($delete_sql) === TRUE) {
        // ÏÇ≠Ï†ú ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        $stats_sql = "SELECT * FROM survey_responses ORDER BY id ASC";
        $stats_result = $conn->query($stats_sql);
        
        $total_responses = $stats_result->num_rows;
        $color_stats = array();
        $coffee_stats = array();
        
        if ($total_responses > 0) {
            while($row = $stats_result->fetch_assoc()) {
                // ÏÉâÏÉÅ ÌÜµÍ≥Ñ
                if(isset($color_stats[$row['favorite_color']])) {
                    $color_stats[$row['favorite_color']]++;
                } else {
                    $color_stats[$row['favorite_color']] = 1;
                }
                
                // Ïª§Ìîº ÌÜµÍ≥Ñ
                if(isset($coffee_stats[$row['coffee_per_day']])) {
                    $coffee_stats[$row['coffee_per_day']]++;
                } else {
                    $coffee_stats[$row['coffee_per_day']] = 1;
                }
            }
            
            $popular_color = array_keys($color_stats, max($color_stats))[0];
            $popular_coffee = array_keys($coffee_stats, max($coffee_stats))[0];
        } else {
            $popular_color = "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå";
            $popular_coffee = "0";
        }
        
        echo json_encode([
            'status' => 'success', 
            'message' => 'ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.',
            'stats' => [
                'total_responses' => $total_responses,
                'popular_color' => $popular_color,
                'popular_coffee' => $popular_coffee
            ]
        ]);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.']);
    }
    $conn->close();
    exit();
}

// POST Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // ÏÑ§Î¨∏ Îç∞Ïù¥ÌÑ∞ Î∞õÍ∏∞
    $favorite_color = isset($_POST['favorite_color']) ? $_POST['favorite_color'] : null;
    $coffee_per_day = isset($_POST['coffee_per_day']) ? $_POST['coffee_per_day'] : null;
    $weekend_activity = isset($_POST['weekend_activity']) ? implode(", ", $_POST['weekend_activity']) : null;
    
    // SQL ÏøºÎ¶¨ Ï§ÄÎπÑ
    $sql = "INSERT INTO survey_responses (favorite_color, coffee_per_day, weekend_activity)
            VALUES ('$favorite_color', '$coffee_per_day', '$weekend_activity')";
    
    // ÏøºÎ¶¨ Ïã§Ìñâ
    if ($conn->query($sql) === TRUE) {
        // Í∏∞Ï°¥ ÏÑ§Î¨∏ Í≤∞Í≥º Ï°∞Ìöå
        $result_sql = "SELECT * FROM survey_responses ORDER BY id ASC";
        $result = $conn->query($result_sql);
        
        // ÏÑ±Í≥µ Î©îÏãúÏßÄÏôÄ ÏÑ§Î¨∏ Í≤∞Í≥º ÌëúÏãú
        echo "<!DOCTYPE html>
        <html lang='ko'>
        <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>ÏÑ§Î¨∏Ï°∞ÏÇ¨ ÏôÑÎ£å</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background-color: #f4f4f4;
                    margin: 0;
                    padding: 20px;
                    min-height: 100vh;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                }
                .success-container {
                    background-color: white;
                    padding: 40px;
                    border-radius: 10px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    text-align: center;
                    margin-bottom: 30px;
                }
                .success-icon {
                    font-size: 60px;
                    color: #4CAF50;
                    margin-bottom: 20px;
                }
                h1 {
                    color: #4CAF50;
                    margin-bottom: 20px;
                }
                p {
                    color: #666;
                    font-size: 16px;
                    line-height: 1.5;
                }
                .back-button {
                    display: inline-block;
                    margin-top: 20px;
                    padding: 10px 20px;
                    background-color: #4CAF50;
                    color: white;
                    text-decoration: none;
                    border-radius: 5px;
                    transition: background-color 0.3s;
                }
                .back-button:hover {
                    background-color: #45a049;
                }
                .results-container {
                    background-color: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                }
                .results-title {
                    color: #333;
                    margin-bottom: 25px;
                    text-align: center;
                    border-bottom: 2px solid #4CAF50;
                    padding-bottom: 10px;
                }
                .results-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                .results-table th {
                    background-color: #4CAF50;
                    color: white;
                    padding: 12px;
                    text-align: left;
                    font-weight: bold;
                }
                .results-table td {
                    padding: 12px;
                    border-bottom: 1px solid #ddd;
                }
                .results-table tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .results-table tr:hover {
                    background-color: #f5f5f5;
                }
                .no-results {
                    text-align: center;
                    color: #666;
                    font-style: italic;
                    padding: 20px;
                }
                .stats-container {
                    display: flex;
                    gap: 20px;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                .stat-box {
                    flex: 1;
                    background-color: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    text-align: center;
                    min-width: 150px;
                }
                .stat-number {
                    font-size: 24px;
                    font-weight: bold;
                    color: #4CAF50;
                }
                .stat-label {
                    color: #666;
                    font-size: 14px;
                }
                .delete-btn {
                    background-color: #f44336;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background-color 0.3s;
                }
                .delete-btn:hover {
                    background-color: #da190b;
                }
                .delete-btn:disabled {
                    background-color: #ccc;
                    cursor: not-allowed;
                }
                .alert {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 1000;
                    display: none;
                }
                .alert.success {
                    background-color: #4CAF50;
                }
                .alert.error {
                    background-color: #f44336;
                }
            </style>
        </head>
        <body>
            <div class='alert' id='alert'></div>
            <div class='container'>
                <div class='success-container'>
                    <div class='success-icon'>‚úì</div>
                    <h1>ÏÑ§Î¨∏Ï°∞ÏÇ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!</h1>
                    <p>ÏÜåÏ§ëÌïú ÏùòÍ≤¨ÏùÑ Ï£ºÏÖîÏÑú Í∞êÏÇ¨Ìï©ÎãàÎã§.<br>
                    Í∑ÄÌïòÏùò ÎãµÎ≥ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.</p>
                    <a href='javascript:history.back()' class='back-button'>ÏÉà ÏÑ§Î¨∏ ÏûëÏÑ±ÌïòÍ∏∞</a>
                </div>
                
                <div class='results-container'>
                    <h2 class='results-title'>üìä ÏÑ§Î¨∏Ï°∞ÏÇ¨ Ï†ÑÏ≤¥ Í≤∞Í≥º</h2>";
        
        if ($result && $result->num_rows > 0) {
            // ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Í≥ÑÏÇ∞
            $total_responses = $result->num_rows;
            $color_stats = array();
            $coffee_stats = array();
            $activity_stats = array();
            
            // ÌÜµÍ≥ÑÎ•º ÏúÑÌï¥ Îç∞Ïù¥ÌÑ∞Î•º Îã§Ïãú Ï°∞Ìöå
            $stats_result = $conn->query($result_sql);
            while($row = $stats_result->fetch_assoc()) {
                // ÏÉâÏÉÅ ÌÜµÍ≥Ñ
                if(isset($color_stats[$row['favorite_color']])) {
                    $color_stats[$row['favorite_color']]++;
                } else {
                    $color_stats[$row['favorite_color']] = 1;
                }
                
                // Ïª§Ìîº ÌÜµÍ≥Ñ
                if(isset($coffee_stats[$row['coffee_per_day']])) {
                    $coffee_stats[$row['coffee_per_day']]++;
                } else {
                    $coffee_stats[$row['coffee_per_day']] = 1;
                }
                
                // ÌôúÎèô ÌÜµÍ≥Ñ
                if(isset($activity_stats[$row['weekend_activity']])) {
                    $activity_stats[$row['weekend_activity']]++;
                } else {
                    $activity_stats[$row['weekend_activity']] = 1;
                }
            }
            
            // ÌÜµÍ≥Ñ Î∞ïÏä§ ÌëúÏãú
            $popular_color = array_keys($color_stats, max($color_stats))[0];
            $popular_coffee = array_keys($coffee_stats, max($coffee_stats))[0];
            
            // ÏÉâÏÉÅ ÌïúÍ∏Ä Î≥ÄÌôò
            $color_korean = '';
            switch($popular_color) {
                case 'Red': $color_korean = 'Îπ®Í∞ï'; break;
                case 'Blue': $color_korean = 'ÌååÎûë'; break;
                case 'Green': $color_korean = 'Ï¥àÎ°ù'; break;
                default: $color_korean = $popular_color; break;
            }
            
            echo "<div class='stats-container'>
                    <div class='stat-box'>
                        <div class='stat-number' id='total-responses'>$total_responses</div>
                        <div class='stat-label'>Ï¥ù ÏùëÎãµ Ïàò</div>
                    </div>
                    <div class='stat-box'>
                        <div class='stat-number' id='popular-color'>$color_korean</div>
                        <div class='stat-label'>Ïù∏Í∏∞ ÏÉâÏÉÅ</div>
                    </div>
                    <div class='stat-box'>
                        <div class='stat-number' id='popular-coffee'>{$popular_coffee}Ïûî</div>
                        <div class='stat-label'>ÌèâÍ∑† Ïª§Ìîº ÏÑ≠Ï∑®Îüâ</div>
                    </div>
                  </div>";
            
            // ÌÖåÏù¥Î∏î ÌëúÏãú
            echo "<table class='results-table' id='resultsTable'>
                    <thead>
                        <tr>
                            <th>Î≤àÌò∏</th>
                            <th>Ï¢ãÏïÑÌïòÎäî ÏÉâÏÉÅ</th>
                            <th>ÌïòÎ£® Ïª§Ìîº ÏÑ≠Ï∑®Îüâ</th>
                            <th>Ï£ºÎßê ÌôúÎèô</th>
                            <th>ÏùëÎãµ ÏãúÍ∞Ñ</th>
                            <th>Í¥ÄÎ¶¨</th>
                        </tr>
                    </thead>
                    <tbody>";
            
            $counter = 1;
            // Îç∞Ïù¥ÌÑ∞Î•º Îã§Ïãú Ï°∞ÌöåÌï¥ÏÑú ÌÖåÏù¥Î∏îÏóê ÌëúÏãú
            $table_result = $conn->query($result_sql);
            while($row = $table_result->fetch_assoc()) {
                $color_korean = '';
                switch($row['favorite_color']) {
                    case 'Red': $color_korean = 'Îπ®Í∞ï'; break;
                    case 'Blue': $color_korean = 'ÌååÎûë'; break;
                    case 'Green': $color_korean = 'Ï¥àÎ°ù'; break;
                    default: $color_korean = $row['favorite_color']; break;
                }
                
                $activity_korean = '';
                switch($row['weekend_activity']) {
                    case 'Sports': $activity_korean = 'Ïö¥ÎèôÌïòÍ∏∞'; break;
                    case 'Movie': $activity_korean = 'ÏòÅÌôî Î≥¥Í∏∞'; break;
                    case 'Reading': $activity_korean = 'Ï±Ö ÏùΩÍ∏∞'; break;
                    default: $activity_korean = $row['weekend_activity']; break;
                }
                
                $created_at = isset($row['created_at']) ? date('Y-m-d H:i', strtotime($row['created_at'])) : 'ÏãúÍ∞Ñ Ï†ïÎ≥¥ ÏóÜÏùå';
                
                echo "<tr id='row-{$row['id']}'>
                        <td>$counter</td>
                        <td>$color_korean</td>
                        <td>{$row['coffee_per_day']}Ïûî</td>
                        <td>$activity_korean</td>
                        <td>$created_at</td>
                        <td>
                            <button class='delete-btn' onclick='deleteResponse({$row['id']})'>ÏÇ≠Ï†ú</button>
                        </td>
                      </tr>";
                $counter++;
            }
            echo "</tbody></table>";
        } else {
            echo "<div class='no-results'>ÏïÑÏßÅ ÏÑ§Î¨∏ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>";
        }
        
        echo "      </div>
            </div>
            
            <script>
                function deleteResponse(id) {
                    if (confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏùëÎãµÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        // ÏÇ≠Ï†ú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                        const button = event.target;
                        button.disabled = true;
                        button.textContent = 'ÏÇ≠Ï†ú Ï§ë...';
                        
                        // AJAX ÏöîÏ≤≠
                        fetch('?delete_id=' + id)
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Ìñâ ÏÇ≠Ï†ú Ïï†ÎãàÎ©îÏù¥ÏÖò
                                    const row = document.getElementById('row-' + id);
                                    row.style.transition = 'opacity 0.3s ease';
                                    row.style.opacity = '0';
                                    
                                    setTimeout(() => {
                                        row.remove();
                                        showAlert(data.message, 'success');
                                        updateRowNumbers();
                                        updateStatistics(data.stats);
                                    }, 300);
                                } else {
                                    showAlert(data.message, 'error');
                                    button.disabled = false;
                                    button.textContent = 'ÏÇ≠Ï†ú';
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showAlert('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                                button.disabled = false;
                                button.textContent = 'ÏÇ≠Ï†ú';
                            });
                    }
                }
                
                function updateStatistics(stats) {
                    // Ï¥ù ÏùëÎãµ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('total-responses').textContent = stats.total_responses;
                    
                    // Ïù∏Í∏∞ ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ (ÌïúÍ∏ÄÎ°ú Î≥ÄÌôò)
                    let colorKorean = '';
                    switch(stats.popular_color) {
                        case 'Red': colorKorean = 'Îπ®Í∞ï'; break;
                        case 'Blue': colorKorean = 'ÌååÎûë'; break;
                        case 'Green': colorKorean = 'Ï¥àÎ°ù'; break;
                        default: colorKorean = stats.popular_color; break;
                    }
                    document.getElementById('popular-color').textContent = colorKorean;
                    
                    // Ïù∏Í∏∞ Ïª§Ìîº ÏÑ≠Ï∑®Îüâ ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('popular-coffee').textContent = stats.popular_coffee + 'Ïûî';
                    
                    // Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ Ï≤òÎ¶¨
                    if (stats.total_responses === 0) {
                        document.getElementById('popular-color').textContent = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
                        document.getElementById('popular-coffee').textContent = '0Ïûî';
                        
                        // ÌÖåÏù¥Î∏îÏùÑ 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå' Î©îÏãúÏßÄÎ°ú ÍµêÏ≤¥
                        const tableContainer = document.querySelector('.results-container');
                        const table = document.getElementById('resultsTable');
                        if (table) {
                            table.innerHTML = \"<div class='no-results'>ÏïÑÏßÅ ÏÑ§Î¨∏ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>\";
                        }
                    }
                }
                
                function showAlert(message, type) {
                    const alert = document.getElementById('alert');
                    alert.textContent = message;
                    alert.className = 'alert ' + type;
                    alert.style.display = 'block';
                    
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 3000);
                }
                
                function updateRowNumbers() {
                    const rows = document.querySelectorAll('#resultsTable tbody tr');
                    rows.forEach((row, index) => {
                        row.cells[0].textContent = index + 1;
                    });
                }
            </script>
        </body>
        </html>";
        
    } else {
        // SQL ÏøºÎ¶¨ Ïò§Î•ò Î©îÏãúÏßÄ Ï∂úÎ†•
        echo "SQL Ïò§Î•ò: " . $conn->error . "<br>";
        echo "Ïã§ÌñâÎêú ÏøºÎ¶¨: " . $sql . "<br>";
    }
    
    // Ïó∞Í≤∞ Ï¢ÖÎ£å
    $conn->close();
}
?>